<html>
<head>
    <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css'>
    <link rel='stylesheet' href='https://cdn.form.io/formiojs/formio.full.min.css'>
    <script src='https://cdn.form.io/formiojs/formio.full.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
</head>
<body>
<div class="row card card-body bg-light mt-4">
    <form role="form" novalidate="" class="" id="fproject">
        <div id="form-group-title" class="form-group">
            <label for="title" class="control-label">Titolo</label>
            <input type="text" class="form-control"
                   id="title" name="title" placeholder="Enter the form title">
        </div>
        <div id="form-group-name" class="form-group">
            <label for="name" class="control-label">Name</label>
            <input type="text" class="form-control  "
                   id="name" name="name" placeholder="Enter the form machine name">
        </div>
        <div class="row">
            <div class="col col-sm-4">
                <div id="form-group-path" class="form-group">
                    <label for="path" class="control-label">Path</label>
                    <input type="text" class="form-control" id="path"
                           name="path" placeholder="example" style="text-transform: lowercase">
                    <small>The path alias for this form.</small>
                </div>
            </div>
            <div class="col col-sm-4">
                <div id="form-group-display" class="form-group">
                    <label for="display" class="control-label">Display as</label>
                    <select id="display" name="display" class="form-control  ">
                        <option label="Form" value="form" selected="selected">Form</option>
                        <option label="Wizard" value="wizard">Wizard</option>
                    </select>
                </div>
            </div>
            <div class="col col-sm-4">
                <div id="form-group-tags" class="form-group">
                    <label for="tags" class="control-label">Tags</label>
                    <input name="tags" id="tags"
                           class=" ng-valid ng-isolate-scope ng-valid-max-tags ng-valid-min-tags ng-valid-leftover-text ng-empty ng-touched"/>
                </div>
            </div>
        </div>
        <input type="hidden" ng-model="form.type" autocomplete="off"
               class=" ng-untouched ng-valid ng-not-empty">


        <div id="builder"></div>

        <input type="textarea" id="json" name="components" disabled autocomplete="off" class=" ">
        <button type="submit">Save</button>
    </form>
</div>

<script type="text/javascript">
    var jsonElement = document.getElementById('json');
    var subJSON = document.getElementById('subjson');
    var builder = new Formio.FormBuilder(document.getElementById("builder"), {
        display: 'form',
        components: {{ components or [] }},
    }, {
        baseUrl: 'http://localhost:9525/mongo_forms'
    });

    var onForm = function (form) {
        form.on('change', function () {
            subJSON.innerHTML = '';
            subJSON.appendChild(document.createTextNode(JSON.stringify(form.submission, null, 0)));
        });
    };

    var onBuild = function (build) {
        let sck = builder.instance.schema
        if (sck.hasOwnProperty("display")) {
            delete sck.display
        }
        jsonElement.value = JSON.stringify(sck);
        // jsonElement.appendChild(document.createTextNode(JSON.stringify(builder.instance.schema, null, 4)));
        // Formio.createForm(formElement, builder.instance.form).then(onForm);
    };

    var onReady = function () {
        var jsonElement = document.getElementById('json');
        builder.instance.on('change', onBuild);
    };

    var setDisplay = function (display) {
        builder.setDisplay(display).then(onReady);
    };

    // Handle the form selection.
    var formSelect = document.getElementById('display');
    formSelect.addEventListener("change", function () {
        setDisplay(this.value);
    });

    builder.instance.ready.then(onReady);
    var serialize = function (x) {
        return JSON.stringify(x, function (k, v) {
            if (!k.startsWith("data"))
                return v;
        });
    };

    $("#fproject").submit(function (e) {
        e.preventDefault(); // disable the POST of the form by the submit button
        // $(this).$("#")
        let self = this;
        var datax = $(self).serializeArray();
        var data = datax.filter(function (dat) {
            return !dat.name.startsWith("data");
        });
        let sck = builder.instance.schema
        if (sck.hasOwnProperty("display")) {
            delete sck.display
        }
        // jsonElement.value = JSON.stringify(sck);
        data.push({name: 'components', value: sck['components']});
        console.log(data);
        $.ajax({
            type: "POST",
            url: "/builder/{{ form_id }}",
            data: JSON.stringify(data),
            beforeSend: function () {
                $("#loader").removeClass("d-none");
            },
            error: function (e) {
                $("#loader").addClass("d-none");
                alert("Errore Interno conttatare Helpdesk", e);
            },
            success: function (result) {
                if ((result.hasOwnProperty('link')) && result.reload) {
                    if (result.link === "#") {
                        window.location.reload();
                    } else {
                        window.location.href = result.link;
                    }
                }
                $("#loader").addClass("d-none");
            },
        });
    });


</script>
</body>
</html>